# 通用错误处理和状态反馈模板
# 所有命令都应该包含这些步骤

name: Command Error Handler Template

# 1. 添加初始反应（表示收到命令）
- name: Add initial reaction
  if: always()
  uses: actions/github-script@v7
  with:
    script: |
      try {
        await github.rest.reactions.createForIssueComment({
          owner: context.repo.owner,
          repo: context.repo.repo,
          comment_id: context.payload.comment.id,
          content: 'eyes'  # 👀 表示正在处理
        });
      } catch (e) {
        console.log('Failed to add reaction:', e.message);
      }

# 2. 主要执行步骤需要设置 id 和错误捕获
- name: Main execution
  id: main
  continue-on-error: true  # 允许继续执行以便报告错误
  run: |
    # 你的主要逻辑
    echo "Executing command..."

# 3. 成功反应
- name: Add success reaction
  if: steps.main.outcome == 'success'
  uses: actions/github-script@v7
  with:
    script: |
      await github.rest.reactions.createForIssueComment({
        owner: context.repo.owner,
        repo: context.repo.repo,
        comment_id: context.payload.comment.id,
        content: 'rocket'  # 🚀 表示成功
      });

# 4. 失败处理
- name: Handle failure
  if: steps.main.outcome == 'failure'
  uses: actions/github-script@v7
  with:
    script: |
      // 添加失败反应
      await github.rest.reactions.createForIssueComment({
        owner: context.repo.owner,
        repo: context.repo.repo,
        comment_id: context.payload.comment.id,
        content: 'confused'  # 😕 表示失败
      });
      
      // 发布错误报告
      const errorMessage = `## ❌ Command Failed
      
      **Command**: \`${context.payload.comment.body}\`
      **Error**: The command execution failed. Please check the logs for details.
      
      ### 📋 Error Details
      \`\`\`
      ${{ steps.main.outputs.error || 'Unknown error occurred' }}
      \`\`\`
      
      ### 💡 Suggestions
      - Check the command syntax
      - Verify required permissions
      - Ensure all dependencies are configured
      
      ### 🔗 Workflow Run
      [View detailed logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
      
      If this issue persists, please report it.`;
      
      await github.rest.issues.createComment({
        owner: context.repo.owner,
        repo: context.repo.repo,
        issue_number: context.issue.number,
        body: errorMessage
      });
      
      // 标记工作流失败
      core.setFailed('Command execution failed');