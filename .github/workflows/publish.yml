name: Publish Command

on:
  issue_comment:
    types: [created]

jobs:
  handle-publish:
    # åªåœ¨ issue/PR è¯„è®ºä¸­åŒ…å« /publish å‘½ä»¤æ—¶è¿è¡Œ
    if: |
      github.event.issue &&
      contains(github.event.comment.body, '/publish')
    
    runs-on: ubuntu-latest
    
    # æƒé™è®¾ç½®
    permissions:
      id-token: write     # OIDC è®¤è¯ï¼ˆnpm trusted publishingï¼‰
      contents: read      # è¯»å–ä»£ç 
      packages: write     # GitHub Packages
      issues: write       # å›å¤è¯„è®º
      pull-requests: write # PR è¯„è®º
    
    # å‘å¸ƒç¯å¢ƒ
    environment:
      name: publish
      url: ${{ steps.publish.outputs.url }}
    
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "Raw comment: $COMMENT"
          
          # æå–å‘½ä»¤è¡Œ
          COMMAND=$(echo "$COMMENT" | grep -o '/publish[^/]*' | head -1 || echo "")
          echo "Extracted command: $COMMAND"
          
          # è§£æå­å‘½ä»¤å’Œé€‰é¡¹
          if echo "$COMMAND" | grep -q "npm"; then
            CHANNEL="npm"
            # è§£æ npm ç‰¹å®šé€‰é¡¹
            if echo "$COMMAND" | grep -q -- "--tag"; then
              TAG=$(echo "$COMMAND" | sed -n 's/.*--tag[[:space:]]\+\([^[:space:]]*\).*/\1/p')
              echo "npm_tag=${TAG:-latest}" >> $GITHUB_OUTPUT
            else
              echo "npm_tag=latest" >> $GITHUB_OUTPUT
            fi
            
            if echo "$COMMAND" | grep -q -- "--access"; then
              ACCESS=$(echo "$COMMAND" | sed -n 's/.*--access[[:space:]]\+\([^[:space:]]*\).*/\1/p')
              echo "npm_access=${ACCESS:-public}" >> $GITHUB_OUTPUT
            else
              echo "npm_access=public" >> $GITHUB_OUTPUT
            fi
            
          elif echo "$COMMAND" | grep -q "docker"; then
            CHANNEL="docker"
            # è§£æ Docker ç‰¹å®šé€‰é¡¹
            if echo "$COMMAND" | grep -q -- "--tag"; then
              TAG=$(echo "$COMMAND" | sed -n 's/.*--tag[[:space:]]\+\([^[:space:]]*\).*/\1/p')
              echo "docker_tag=${TAG:-latest}" >> $GITHUB_OUTPUT
            else
              echo "docker_tag=latest" >> $GITHUB_OUTPUT
            fi
            
            if echo "$COMMAND" | grep -q -- "--registry"; then
              REGISTRY=$(echo "$COMMAND" | sed -n 's/.*--registry[[:space:]]\+\([^[:space:]]*\).*/\1/p')
              echo "docker_registry=${REGISTRY:-docker.io}" >> $GITHUB_OUTPUT
            else
              echo "docker_registry=docker.io" >> $GITHUB_OUTPUT
            fi
            
            if echo "$COMMAND" | grep -q -- "--platform"; then
              PLATFORM=$(echo "$COMMAND" | sed -n 's/.*--platform[[:space:]]\+\([^[:space:]]*\).*/\1/p')
              echo "docker_platform=${PLATFORM:-linux/amd64}" >> $GITHUB_OUTPUT
            else
              echo "docker_platform=linux/amd64" >> $GITHUB_OUTPUT
            fi
            
          else
            CHANNEL="auto"
          fi
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥ dry-run æ¨¡å¼
          if echo "$COMMAND" | grep -q -- "--dry-run"; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
          else
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check permissions
        id: permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            
            try {
              // æ£€æŸ¥ç”¨æˆ·æƒé™
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username
              });
              
              // éœ€è¦ write æƒé™æ‰èƒ½å‘å¸ƒ
              const allowed = ['admin', 'maintain', 'write'].includes(permission.permission);
              console.log(`User ${username} has ${permission.permission} permission: ${allowed ? 'allowed' : 'denied'}`);
              
              if (!allowed) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.issue.number,
                  body: `âŒ @${username} ä½ æ²¡æœ‰å‘å¸ƒæƒé™ã€‚éœ€è¦ write ä»¥ä¸Šæƒé™æ‰èƒ½æ‰§è¡Œ /publish å‘½ä»¤ã€‚`
                });
              }
              
              return allowed;
            } catch (error) {
              console.error('Error checking permissions:', error);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `âŒ æ£€æŸ¥æƒé™æ—¶å‡ºé”™: ${error.message}`
              });
              return false;
            }
          result-encoding: string
      
      - name: React to comment
        if: steps.permissions.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
      
      - name: Checkout code
        if: steps.permissions.outputs.result == 'true'
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²ä»¥æ£€æŸ¥æ ‡ç­¾
          fetch-depth: 0
          # å¦‚æœæ˜¯ PRï¼Œcheckout åˆ° PR çš„åˆ†æ”¯
          ref: ${{ github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Detect latest release
        if: steps.permissions.outputs.result == 'true'
        id: version
        run: |
          # è·å–æœ€æ–°çš„ç‰ˆæœ¬æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç‰ˆæœ¬æ ‡ç­¾ï¼Œè¯·å…ˆæ‰§è¡Œ /release å‘½ä»¤"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "has_release=true" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION="${LATEST_TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Auto-detect project type
        if: steps.permissions.outputs.result == 'true' && steps.parse.outputs.channel == 'auto'
        id: detect
        run: |
          CHANNEL=""
          
          # æ£€æµ‹é¡¹ç›®ç±»å‹
          if [ -f "package.json" ]; then
            # æ£€æŸ¥æ˜¯å¦æ˜¯åº“ï¼ˆæœ‰ main/module/exports å­—æ®µï¼‰
            if grep -q '"main"\|"module"\|"exports"' package.json; then
              CHANNEL="npm"
              echo "æ£€æµ‹åˆ° Node.js åº“é¡¹ç›®"
            elif [ -f "Dockerfile" ]; then
              CHANNEL="docker"
              echo "æ£€æµ‹åˆ° Node.js åº”ç”¨é¡¹ç›®ï¼ˆæœ‰ Dockerfileï¼‰"
            else
              CHANNEL="npm"
              echo "æ£€æµ‹åˆ° Node.js é¡¹ç›®ï¼ˆé»˜è®¤å‘å¸ƒåˆ° npmï¼‰"
            fi
          elif [ -f "Dockerfile" ]; then
            CHANNEL="docker"
            echo "æ£€æµ‹åˆ° Docker é¡¹ç›®"
          elif [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            echo "æ£€æµ‹åˆ° Python é¡¹ç›®ï¼ˆæš‚ä¸æ”¯æŒï¼‰"
            CHANNEL="unsupported"
          elif [ -f "go.mod" ]; then
            if [ -f "Dockerfile" ]; then
              CHANNEL="docker"
              echo "æ£€æµ‹åˆ° Go åº”ç”¨é¡¹ç›®ï¼ˆæœ‰ Dockerfileï¼‰"
            else
              echo "æ£€æµ‹åˆ° Go é¡¹ç›®ï¼ˆæš‚ä¸æ”¯æŒï¼‰"
              CHANNEL="unsupported"
            fi
          else
            echo "æ— æ³•æ£€æµ‹é¡¹ç›®ç±»å‹"
            CHANNEL="unknown"
          fi
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
      
      - name: Set final channel
        if: steps.permissions.outputs.result == 'true'
        id: channel
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ˜¾å¼æŒ‡å®šçš„æ¸ é“ï¼Œå¦åˆ™ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„ç»“æœ
          if [ "${{ steps.parse.outputs.channel }}" = "auto" ]; then
            CHANNEL="${{ steps.detect.outputs.channel }}"
          else
            CHANNEL="${{ steps.parse.outputs.channel }}"
          fi
          
          echo "Final channel: $CHANNEL"
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
      
      - name: Check release exists
        if: steps.permissions.outputs.result == 'true' && steps.version.outputs.has_release != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ æœªæ‰¾åˆ°ç‰ˆæœ¬æ ‡ç­¾ã€‚è¯·å…ˆæ‰§è¡Œ \`/release\` å‘½ä»¤åˆ›å»ºç‰ˆæœ¬ã€‚`
            });
            core.setFailed('No release found');
      
      # ============ npm å‘å¸ƒæµç¨‹ ============
      - name: Setup Node.js for npm
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Publish to npm
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'npm'
        id: npm-publish
        run: |
          echo "Publishing npm package..."
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Tag: ${{ steps.parse.outputs.npm_tag }}"
          echo "Access: ${{ steps.parse.outputs.npm_access }}"
          echo "Dry run: ${{ steps.parse.outputs.dry_run }}"
          
          # è¿è¡Œå‘å¸ƒè„šæœ¬
          chmod +x .github/workflows/commands/publish/scripts/npm.sh
          .github/workflows/commands/publish/scripts/npm.sh \
            --version "${{ steps.version.outputs.version }}" \
            --tag "${{ steps.parse.outputs.npm_tag }}" \
            --access "${{ steps.parse.outputs.npm_access }}" \
            ${{ steps.parse.outputs.dry_run == 'true' && '--dry-run' || '' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
      
      # ============ Docker å‘å¸ƒæµç¨‹ ============
      - name: Set up Docker Buildx
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'docker'
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'docker' &&
          steps.parse.outputs.docker_registry == 'docker.io' &&
          steps.parse.outputs.dry_run != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Log in to GitHub Container Registry
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'docker' &&
          steps.parse.outputs.docker_registry == 'ghcr.io' &&
          steps.parse.outputs.dry_run != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish Docker image
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          steps.channel.outputs.channel == 'docker'
        id: docker-publish
        run: |
          echo "Publishing Docker image..."
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Registry: ${{ steps.parse.outputs.docker_registry }}"
          echo "Tag: ${{ steps.parse.outputs.docker_tag }}"
          echo "Platform: ${{ steps.parse.outputs.docker_platform }}"
          echo "Dry run: ${{ steps.parse.outputs.dry_run }}"
          
          # è¿è¡Œå‘å¸ƒè„šæœ¬
          chmod +x .github/workflows/commands/publish/scripts/docker.sh
          .github/workflows/commands/publish/scripts/docker.sh \
            --version "${{ steps.version.outputs.version }}" \
            --registry "${{ steps.parse.outputs.docker_registry }}" \
            --tag "${{ steps.parse.outputs.docker_tag }}" \
            --platform "${{ steps.parse.outputs.docker_platform }}" \
            ${{ steps.parse.outputs.dry_run == 'true' && '--dry-run' || '' }}
      
      # ============ ä¸æ”¯æŒçš„æ¸ é“å¤„ç† ============
      - name: Handle unsupported channel
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.channel.outputs.channel == 'unsupported'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âš ï¸ æ£€æµ‹åˆ°çš„é¡¹ç›®ç±»å‹æš‚ä¸æ”¯æŒè‡ªåŠ¨å‘å¸ƒã€‚\n\nç›®å‰æ”¯æŒçš„å‘å¸ƒæ¸ é“ï¼š\n- \`/publish npm\` - å‘å¸ƒåˆ° npm registry\n- \`/publish docker\` - å‘å¸ƒåˆ° Docker Hub`
            });
      
      - name: Handle unknown project
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.channel.outputs.channel == 'unknown'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ æ— æ³•è‡ªåŠ¨æ£€æµ‹é¡¹ç›®ç±»å‹ã€‚\n\nè¯·æ˜¾å¼æŒ‡å®šå‘å¸ƒæ¸ é“ï¼š\n- \`/publish npm\` - å‘å¸ƒåˆ° npm registry\n- \`/publish docker\` - å‘å¸ƒåˆ° Docker Hub`
            });
      
      # ============ æˆåŠŸåé¦ˆ ============
      - name: Comment success
        if: |
          steps.permissions.outputs.result == 'true' && 
          steps.version.outputs.has_release == 'true' &&
          (steps.npm-publish.outcome == 'success' || steps.docker-publish.outcome == 'success')
        uses: actions/github-script@v7
        with:
          script: |
            const channel = '${{ steps.channel.outputs.channel }}';
            const version = '${{ steps.version.outputs.version }}';
            const dryRun = '${{ steps.parse.outputs.dry_run }}' === 'true';
            
            let message = '';
            
            if (dryRun) {
              message = `âœ… å‘å¸ƒé¢„è§ˆæˆåŠŸï¼\n\n`;
              message += `**ç‰ˆæœ¬**: ${version}\n`;
              message += `**æ¸ é“**: ${channel}\n\n`;
              message += `è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œå®é™…æœªå‘å¸ƒã€‚ç§»é™¤ \`--dry-run\` å‚æ•°ä»¥æ‰§è¡ŒçœŸæ­£çš„å‘å¸ƒã€‚`;
            } else {
              if (channel === 'npm') {
                const tag = '${{ steps.parse.outputs.npm_tag }}';
                const packageName = require('./package.json').name;
                message = `ğŸ‰ æˆåŠŸå‘å¸ƒåˆ° npm!\n\n`;
                message += `**åŒ…å**: ${packageName}\n`;
                message += `**ç‰ˆæœ¬**: ${version}\n`;
                message += `**æ ‡ç­¾**: ${tag}\n\n`;
                message += `å®‰è£…å‘½ä»¤:\n\`\`\`bash\nnpm install ${packageName}@${tag}\n\`\`\``;
              } else if (channel === 'docker') {
                const registry = '${{ steps.parse.outputs.docker_registry }}';
                const tag = '${{ steps.parse.outputs.docker_tag }}';
                const imageName = `${registry}/${context.repo.owner}/${context.repo.repo}`;
                message = `ğŸ‰ æˆåŠŸå‘å¸ƒåˆ° Docker!\n\n`;
                message += `**é•œåƒ**: ${imageName}\n`;
                message += `**ç‰ˆæœ¬**: ${version}\n`;
                message += `**æ ‡ç­¾**: ${tag}\n\n`;
                message += `æ‹‰å–å‘½ä»¤:\n\`\`\`bash\ndocker pull ${imageName}:${tag}\n\`\`\``;
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });